import{saveAs}from"file-saver";import{sha256}from"js-sha256";import JSZip from"jszip";import bigInt from"big-integer";const BASE91_TABLE=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","0","1","2","3","4","5","6","7","8","9","!","#","$","%","&","(",")","*","+",",","-",".","/",":",";","<","=",">","?","@","[","]","^","_","`","{","|","}","~"];function ankiHash(n){const e=n.join("__"),t=sha256.create();t.update(e);const o=t.digest();let l=bigInt();for(let n=0;n<8;n++)l*=bigInt("256"),l+=bigInt(o[n]);let s=[];for(;l>0;)s.push(BASE91_TABLE[l%bigInt("91")]),l/=bigInt("91");return s.reverse().join("")}const MODEL_STD=0,MODEL_CLOZE=1;export class Model{constructor(n){this.props={...defaultModel,...n,flds:n.flds.map((n,e)=>({...defaultField,ord:e,...n})),tmpls:n.tmpls.map((n,e)=>({...defaultTemplate,ord:e,name:`Card ${e+1}`,...n})),mod:(new Date).getTime()},this.fieldNameToOrd={},this.props.flds.forEach(n=>{this.fieldNameToOrd[n.name]=n.ord})}note(n,e,t=null){if(Array.isArray(n)){if(n.length!==this.props.flds.length)throw new Error(`Expected ${this.props.flds.length} fields for model '${this.props.name}' but got ${n.length}`);return new Note(this,n,e,t)}{const o=Object.keys(n),l=[];return o.forEach(e=>{const t=this.fieldNameToOrd[e];if(null==t)throw new Error(`Field '${e}' does not exist in the model`);l[t]=n[e]}),new Note(this,l,e,t)}}}export class ClozeModel extends Model{constructor(n){super({type:MODEL_CLOZE,css:"\n         .card {\n           font-family: arial;\n           font-size: 20px;\n           text-align: center;\n           color: black;\n           background-color: white;\n         }\n \n         .cloze {\n           font-weight: bold;\n           color: blue;\n         }\n       ",tmpls:[{name:"Cloze",...n.tmpl}],...n})}}export const defaultModel={sortf:0,did:1,latexPre:"\\documentclass[12pt]{article}\n \\special{papersize=3in,5in}\n \\usepackage[utf8]{inputenc}\n \\usepackage{amssymb,amsmath}\n \\pagestyle{empty}\n \\setlength{\\parindent}{0in}\n \\begin{document}",latexPost:"\\end{document}",mod:0,usn:0,vers:[],type:MODEL_STD,css:".card {\n  font-family: arial;\n  font-size: 20px;\n  text-align: center;\n  color: black;\n  background-color: white;\n }",tags:[]};export const defaultField={name:"",ord:null,sticky:!1,rtl:!1,font:"Arial",size:20,media:[]};export const defaultTemplate={name:"",ord:null,qfmt:"",afmt:"",did:null,bqfmt:"",bafmt:""};const NEW_CARDS_DISTRIBUTE=0,NEW_CARDS_LAST=1,NEW_CARDS_FIRST=2;export const defaultConf={activeDecks:[1],curDeck:1,newSpread:0,collapseTime:1200,timeLim:0,estTimes:!0,dueCounts:!0,curModel:null,nextPos:1,sortType:"noteFld",sortBackwards:!1,addToCur:!0,dayLearnFirst:!1};const NEW_CARDS_RANDOM=0,NEW_CARDS_DUE=1,STARTING_FACTOR=2500;export const defaultDeckConf={name:"Default",new:{delays:[1,10],ints:[1,4,7],initialFactor:2500,separate:!0,order:1,perDay:20,bury:!1},lapse:{delays:[10],mult:0,minInt:1,leechFails:8,leechAction:0},rev:{perDay:200,ease4:1.3,fuzz:.05,minSpace:1,ivlFct:1,maxIvl:36500,bury:!1,hardFactor:1.2},maxTaken:60,timer:0,autoplay:!0,replayq:!0,mod:0,usn:0};export const defaultDeck={newToday:[0,0],revToday:[0,0],lrnToday:[0,0],timeToday:[0,0],conf:1,usn:0,desc:"",dyn:0,collapsed:!1,extendNew:10,extendRev:50};export class Deck{constructor(n,e,t=""){this.id=n,this.name=e,this.desc=t,this.notes=[]}addNote(n){this.notes.push(n)}}export class Note{constructor(n,e,t=null,o=null){this.model=n,this.fields=e,this.tags=t,this._guid=o}get guid(){return this._guid?this._guid:ankiHash(this.fields)}get cards(){if(this.model.props.type===MODEL_STD){const n=n=>!n||0===n.toString().trim().length,e=[];for(const[t,o,l]of this.model.props.req){l["any"===o?"some":"every"](e=>!n(this.fields[e]))&&e.push(t)}return e}{const n=new Set,e=[],t=/{{[^}]*?cloze:(?:[^}]?:)*(.+?)}}/g,o=/<%cloze:(.+?)%>/g,{qfmt:l}=this.model.props.tmpls[0];let s;for(;s=t.exec(l);)e.push(s[1]);for(;s=o.exec(l);)e.push(s[1]);const i={};this.model.props.flds.forEach((n,e)=>{i[n.name]=[e,n]});for(const t of e){if(!(t in i))continue;const e=i[t][0],o=/{{c(\d+)::.+?}}/gs;for(;s=o.exec(this.fields[e]);){const e=parseInt(s[1]);e>0&&n.add(e-1)}}return 0===n.size?[0]:Array.from(n)}}}export class Package{constructor(){this.db=null,this.decks=[],this.media=[]}setSqlJs(n){this.db=n}addDeck(n){this.decks.push(n)}addMedia(n,e){this.media.push({name:e,data:n})}addMediaFile(n,e=null){this.media.push({name:e||n,filename:n})}writeToFile(n){let e=this.db;e.run(APKG_SCHEMA),this.write(e);let t=new JSZip;const o=e.export(),l=new Uint8Array(o).buffer;t.file("collection.anki2",l);const s={};this.media.forEach((n,e)=>{null!=n.filename?t.file(e.toString(),n.filename):t.file(e.toString(),n.data),s[e]=n.name}),t.file("media",JSON.stringify(s)),t.generateAsync({type:"blob",mimeType:"application/apkg"}).then(function(e){saveAs(e,n)})}write(n){const e=new Date,t={},o={};o[1]={...defaultDeck,id:1,name:"Default"},this.decks.forEach(n=>{n.notes.forEach(n=>t[n.model.props.id]=n.model.props),o[n.id]={...defaultDeck,id:n.id,name:n.name,desc:n.desc}});const l=[null,+e/1e3|0,+e,+e,11,0,0,0,JSON.stringify(defaultConf),JSON.stringify(t),JSON.stringify(o),JSON.stringify({1:{id:1,...defaultDeckConf}}),JSON.stringify({})];n.prepare("INSERT INTO col\n         (id, crt, mod, scm, ver, dty, usn, ls, conf, models, decks, dconf, tags)\n         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)").run(l);const s=n.prepare("INSERT INTO notes (id, guid, mid, mod, usn, tags, flds, sfld, csum, flags, data) \n        VALUES (null, ?, ?, ?, ?, ?, ?, ?, 0, 0, '')"),i=n.prepare("INSERT INTO cards (id, nid, did, ord, mod, usn, type, queue, due, ivl, factor, reps, lapses, left, odue, odid, flags, data) \n        VALUES (null, ?, ?, ?, ?, ?, ?, ?, 0, 0, 0, 0, 0, 0, 0, 0, 0, '')");for(const t of this.decks)for(const o of t.notes){let l=null==o.tags?"":o.tags.join(" ");s.run([o.guid,o.model.props.id,+e/1e3|0,-1,l,o.fields.join(""),0]);let r=n.exec("select last_insert_rowid();")[0].values[0][0];for(const n of o.cards)i.run([r,t.id,n,+e/1e3|0,-1,0,0])}}}export const APKG_SCHEMA="\nPRAGMA foreign_keys=OFF;\nBEGIN TRANSACTION;\n\nCREATE TABLE col (\n    id              integer primary key,\n    crt             integer not null,\n    mod             integer not null,\n    scm             integer not null,\n    ver             integer not null,\n    dty             integer not null,\n    usn             integer not null,\n    ls              integer not null,\n    conf            text not null,\n    models          text not null,\n    decks           text not null,\n    dconf           text not null,\n    tags            text not null\n);\nCREATE TABLE notes (\n    id              integer primary key,   /* 0 */\n    guid            text not null,         /* 1 */\n    mid             integer not null,      /* 2 */\n    mod             integer not null,      /* 3 */\n    usn             integer not null,      /* 4 */\n    tags            text not null,         /* 5 */\n    flds            text not null,         /* 6 */\n    sfld            integer not null,      /* 7 */\n    csum            integer not null,      /* 8 */\n    flags           integer not null,      /* 9 */\n    data            text not null          /* 10 */\n);\nCREATE TABLE cards (\n    id              integer primary key,   /* 0 */\n    nid             integer not null,      /* 1 */\n    did             integer not null,      /* 2 */\n    ord             integer not null,      /* 3 */\n    mod             integer not null,      /* 4 */\n    usn             integer not null,      /* 5 */\n    type            integer not null,      /* 6 */\n    queue           integer not null,      /* 7 */\n    due             integer not null,      /* 8 */\n    ivl             integer not null,      /* 9 */\n    factor          integer not null,      /* 10 */\n    reps            integer not null,      /* 11 */\n    lapses          integer not null,      /* 12 */\n    left            integer not null,      /* 13 */\n    odue            integer not null,      /* 14 */\n    odid            integer not null,      /* 15 */\n    flags           integer not null,      /* 16 */\n    data            text not null          /* 17 */\n);\nCREATE TABLE revlog (\n    id              integer primary key,\n    cid             integer not null,\n    usn             integer not null,\n    ease            integer not null,\n    ivl             integer not null,\n    lastIvl         integer not null,\n    factor          integer not null,\n    time            integer not null,\n    type            integer not null\n);\nCREATE TABLE graves (\n    usn             integer not null,\n    oid             integer not null,\n    type            integer not null\n);\nCREATE INDEX ix_notes_usn on notes (usn);\nCREATE INDEX ix_cards_usn on cards (usn);\nCREATE INDEX ix_revlog_usn on revlog (usn);\nCREATE INDEX ix_cards_nid on cards (nid);\nCREATE INDEX ix_cards_sched on cards (did, queue, due);\nCREATE INDEX ix_revlog_cid on revlog (cid);\nCREATE INDEX ix_notes_csum on notes (csum);\nCOMMIT;\n";